{% extends "base.html" %}

{% block title %}Orders{% endblock %}

{% block body %}

<div class="container">
    <h1>Orders</h1>
    
    <!-- Display last 6 orders -->
    <div class="row">
        {% for order in last_orders %}
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header">
                        Order #{{ order.order_id }}
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">{{ order.order_name }}</h5>
                        <p class="card-text"><strong>Description:</strong> {{ order.order_description }}</p>
                        <p class="card-text"><strong>Department:</strong> {{ order.department_name }}</p>
                        <p class="card-text">
                            <strong>State:</strong>
                            <span class="badge {{ 'badge-success' if order.order_state == 'in progress' else 'badge-danger' if order.order_state == 'waiting' else 'badge-secondary' }}" id="order-state-{{ order.order_id }}">
                                {{ order.order_state }}
                            </span>
                        </p>
                        <form action="{{ url_for('change_order_state', order_id=order.order_id) }}" method="post" class="change-state-form" data-order-id="{{ order.order_id }}">
                            <select name="new_state" class="form-control">
                                <option value="in progress" {% if order.order_state == 'in progress' %}selected{% endif %}>In Progress</option>
                                <option value="waiting" {% if order.order_state == 'waiting' %}selected{% endif %}>Waiting</option>
                                <option value="completed" {% if order.order_state == 'completed' %}selected{% endif %}>Completed</option>
                            </select>
                        </form>
                        <br>
                        <a href="{{ url_for('edit_order', order_id=order.order_id) }}" class="btn btn-primary">Edit</a>
                        <form action="{{ url_for('delete_order', order_id=order.order_id) }}" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Button to navigate to add_order page -->
    <div class="text-center mb-4">
        <a href="{{ url_for('add_order') }}" class="btn btn-primary btn-lg">Add Order</a>
    </div>
    
</div>

<!-- Full jQuery (necessary for AJAX) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    $('.change-state-form select[name="new_state"]').on('change', function() {
        var $form = $(this).closest('form');
        var orderId = $form.data('order-id');
        var url = $form.attr('action');
        var newState = $(this).val();

        $.ajax({
            type: 'POST',
            url: url,
            data: $form.serialize(),
            success: function(response) {
                if (response.success) {
                    var badgeClass = '';
                    if (response.new_state === 'in progress') {
                        badgeClass = 'badge-success';
                    } else if (response.new_state === 'waiting') {
                        badgeClass = 'badge-danger';
                    } else {
                        badgeClass = 'badge-secondary';
                    }
                    $('#order-state-' + orderId)
                        .removeClass('badge-success badge-danger badge-secondary')
                        .addClass(badgeClass)
                        .text(response.new_state);
                } else {
                    alert('Failed to change order state');
                }
            },
            error: function() {
                alert('Error changing order state');
            }
        });
    });
});
</script>

{% endblock %}
